import{createPage as I,preparePageComponent as B,preparePageData as N,preparePagesComponents as V,preparePagesData as K,preparePagesRoutes as j}from"@vuepress/core";import{watch as A}from"chokidar";import{Logger as F,keys as G,getPageExcerpt as J}from"vuepress-shared/node";import{isString as T,isFunction as U,removeLeadingSlash as P}from"@vuepress/shared";import{colors as m}from"@vuepress/utils";const p=new F("vuepress-plugin-blog2"),L=(t,w)=>{const h={};return G({"/":{},...w.options.locales}).forEach(u=>{h[u]=[]}),w.pages.filter(t).forEach(u=>{h[u.pathLocale].push(u)}),h},z=`
if (import.meta.webpackHot) {
  import.meta.webpackHot.accept();
  if (__VUE_HMR_RUNTIME__.updateBlogCategory)
    __VUE_HMR_RUNTIME__.updateBlogCategory(categoryMap);
}

if (import.meta.hot)
  import.meta.hot.accept(({ categoryMap }) => {
    __VUE_HMR_RUNTIME__.updateBlogCategory(categoryMap);
  });

`,O=(t,{category:w,slugify:h},u,k=!1)=>Promise.all(w.map(async({key:a,getter:d,sorter:$=()=>-1,path:l="/:key/",layout:_="Layout",frontmatter:v=()=>({}),itemPath:b="/:key/:name/",itemLayout:M="Layout",itemFrontmatter:E=()=>({})},g)=>{if(!T(a)||!a.length)return p.error(`Invalid ${m.magenta("key")} option ${m.cyan(a)} in ${m.cyan(`category[${g}]`)}`),null;if(!U(d))return p.error(`Invalid ${m.magenta("getter")} option in "${m.cyan(`category[${g}]`)}", it should be a function!`),null;t.env.isDebug&&p.info(`Generating ${m.cyan(a)} category.
`);const e={},c=[],i=U(b)?b:r=>(b||"").replace(/:key/g,h(a)).replace(/:name/g,h(r));for(const r in u){if(l){const o=`${r}${P(l.replace(/:key/g,h(a)))}`,s=await I(t,{path:o,frontmatter:{...v(r),blog:{type:"category",key:a},layout:_}}),n=t.pages.findIndex(({path:f})=>f===o);n===-1?t.pages.push(s):t.pages[n].key!==s.key&&(t.pages.splice(n,1,s),k&&p.warn(`Overriding existed path ${m.cyan(o)}`)),c.push(s.key),e[r]={path:s.path,map:{}}}else e[r]={path:"",map:{}};const{map:y}=e[r],R={};for(const o of u[r]){const s=d(o);for(const n of s){if(!y[n]){const f=i(n);if(f){const C=`${r}${P(f)}`,x=await I(t,{path:`${r}${P(f)}`,frontmatter:{...E(n,r),blog:{type:"category",name:n,key:a},layout:M}}),D=t.pages.findIndex(({path:S})=>S===C);D===-1?t.pages.push(x):t.pages[D].key!==x.key&&(t.pages.splice(D,1,x),k&&p.warn(`Overriding existed path ${C}`)),c.push(x.key),y[n]={path:x.path,keys:[]}}else y[n]={path:"",keys:[]};R[n]=[]}R[n].push(o)}}for(const o in R)y[o].keys=R[o].sort($).map(({key:s})=>s);if(t.env.isDebug){let o=`Route ${r} in ${a} category:
`;for(const s in y){const{path:n,keys:f}=y[s];o+=`name: ${s}; ${n?`path: ${n}; `:""}items: ${f.length}
`}p.info(o)}}return{key:a,map:e,pageKeys:c}})).then(async a=>{const d={},$=[];return a.filter(l=>l!==null).forEach(({key:l,map:_,pageKeys:v})=>{d[l]=_,$.push(...v)}),await t.writeTemp("blog/category.js",`export const categoryMap = ${JSON.stringify(d)};
${t.env.isDev?z:""}
`),t.env.isDebug&&p.info("All categories generated."),$}),W=t=>{"customElement"in t&&(p.warn(`${m.magenta("customElement")} is deprecated, please use ${m.magenta("isCustomElement")}.`),t.isCustomElement=t.customElement)},q=`
if (import.meta.webpackHot) {
  import.meta.webpackHot.accept();
  if (__VUE_HMR_RUNTIME__.updateBlogType)
    __VUE_HMR_RUNTIME__.updateBlogType(typeMap);
}

if (import.meta.hot)
  import.meta.hot.accept(({ typeMap }) => {
    __VUE_HMR_RUNTIME__.updateBlogType(typeMap);
  });
`,H=(t,{type:w,slugify:h},u,k=!1)=>Promise.all(w.map(async({key:a,sorter:d=()=>-1,filter:$=()=>!0,path:l="/:key/",layout:_="Layout",frontmatter:v=()=>({})},b)=>{if(!T(a)||!a.length)return p.error(`Invalid ${m.magenta("key")} option ${m.cyan(a)} in ${m.cyan(`type[${b}]`)}`),null;const M={},E=[];t.env.isDebug&&p.info(`Generating ${m.cyan(a)} type.
`);for(const g in u){const e=u[g].filter($).sort(d).map(({key:c})=>c);if(l){const c=`${g}${P(h(l.replace(/:key/g,a)))}`,i=await I(t,{path:c,frontmatter:{...v(g),blog:{type:"type",key:a},layout:_}}),r=t.pages.findIndex(({path:y})=>y===c);r===-1?t.pages.push(i):t.pages[r].key!==i.key&&(t.pages.splice(r,1,i),k&&p.warn(`Overriding existed path ${m.cyan(c)}`)),E.push(i.key),M[g]={path:i.path,keys:e},t.env.isDebug&&p.info(`Route ${g} in ${a} type: path: ${i.path}; items: ${e.length}
`)}else M[g]={path:"",keys:e},t.env.isDebug&&p.info(`Route ${g} in ${a} type: items: ${e.length}
`)}return{key:a,map:M,pageKeys:E}})).then(async a=>{const d={},$=[];return a.filter(l=>l!==null).forEach(({key:l,map:_,pageKeys:v})=>{d[l]=_,$.push(...v)}),await t.writeTemp("blog/type.js",`export const typeMap = ${JSON.stringify(d)};
${t.env.isDev?q:""}
`),t.env.isDebug&&p.info("All types generated."),$}),Q=(t,w=!0)=>h=>{w&&W(t);const{getInfo:u=()=>({}),filter:k=e=>Boolean(e.filePathRelative)&&!e.frontmatter.home,metaScope:a="_blog",excerpt:d=!0,excerptSeparator:$="<!-- more -->",excerptLength:l=300,excerptFilter:_=k,isCustomElement:v=()=>!1,category:b=[],type:M=[],slugify:E=e=>e.replace(/[ _]/g,"-").replace(/[:?*|\\/<>]/g,"").toLowerCase()}=t;let g=[];return h.env.isDebug&&p.info("Options:",t),{name:"vuepress-plugin-blog2",define:()=>({BLOG_META_SCOPE:a}),extendsPage:e=>{d&&_(e)&&(e.data.excerpt=J(h,e,{isCustomElement:v,excerptSeparator:$,excerptLength:l})),k(e)&&(e.routeMeta={...a===""?u(e):{[a]:u(e)},...e.routeMeta})},onInitialized:e=>{const c=L(k,e);return Promise.all([O(e,{category:b,slugify:E},c,!0).then(i=>{g.push(...i)}),H(e,{type:M,slugify:E},c,!0).then(i=>{g.push(...i)})]).then(()=>{e.env.isDebug&&p.info("temp file generated")})},onWatched:(e,c)=>{if("hotReload"in t?t.hotReload:e.env.isDebug){const i=A("pages/**/*.js",{cwd:e.dir.temp(),ignoreInitial:!0}),r=()=>{const y=[],R=L(k,e);return Promise.all([O(e,{category:b,slugify:E},R).then(o=>{y.push(...o)}),H(e,{type:M,slugify:E},R).then(o=>{y.push(...o)})]).then(async()=>{const o=g.filter(n=>!y.includes(n)),s=y.filter(n=>!g.includes(n));s.length&&(e.env.isDebug&&p.info(`New pages detected: ${s.toString()}`),await Promise.all(s.map(async n=>{await B(e,e.pages.find(({key:f})=>f===n)),await N(e,e.pages.find(({key:f})=>f===n))}))),o.length&&(e.env.isDebug&&p.info(`Removing following pages: ${o.toString()}`),o.forEach(n=>{e.pages.splice(e.pages.findIndex(({key:f})=>f===n),1)})),(o.length||s.length)&&(await V(e),await K(e),await j(e)),g=y,e.env.isDebug&&p.info("temp file updated")})};i.on("add",()=>{r()}),i.on("change",()=>{r()}),i.on("unlink",()=>{r()}),c.push(i)}}}};export{Q as blogPlugin};
//# sourceMappingURL=index.js.map
