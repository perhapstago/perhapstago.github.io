import{getDirname as b,path as D,colors as S,fs as $}from"@vuepress/utils";import{ensureEndingSlash as P,isLinkHttp as U,removeEndingSlash as L,removeLeadingSlash as O}from"@vuepress/shared";import{SitemapStream as G}from"sitemap";import{Logger as M}from"vuepress-shared/node";const q=b(import.meta.url),X=P(D.resolve(q,"../../templates")),u=new M("vuepress-plugin-sitemap2"),v=({options:e,deprecatedOption:t,newOption:o,msg:i="",scope:l=""})=>{if(t in e){if(u.warn(`${S.magenta(t)} is ${S.yellow("deprecated")}${l?` in ${l}`:""}, please use "${S.magenta(o)}" instead.${i?`
${i}`:""}`),o.includes(".")){const m=o.split(".");let r=e;m.forEach((c,h)=>{h!==m.length-1?(r[c]=r[c]||{},r=r[c]):r[c]=e[t]})}else e[o]=e[t];delete e[t]}},k=e=>{v({options:e,deprecatedOption:"urls",newOption:"extraUrls"}),v({options:e,deprecatedOption:"exclude",newOption:"excludeUrls"}),v({options:e,deprecatedOption:"outFile",newOption:"sitemapFilename"}),v({options:e,deprecatedOption:"dateFormatter",newOption:"modifyTimeGetter"})},E=[],T=e=>({defaultPath:e.path.replace(e.pathLocale,"/"),pathLocale:e.pathLocale}),A=(e,t)=>{const{changefreq:o="daily",excludeUrls:i=["/404.html"],modifyTimeGetter:l=n=>{var s;return(s=n.data.git)!=null&&s.updatedTime?new Date(n.data.git.updatedTime).toISOString():""}}=t,{pages:m,options:{base:r,locales:c}}=e,h=m.reduce((n,s)=>{const{defaultPath:p,pathLocale:w}=T(s),d=n.get(p)||[];return d.push(w),n.set(p,d)},new Map),f=new Map;return m.forEach(n=>{const s=n.frontmatter.sitemap;if(s===!1)return;const p=(n.frontmatter.head||[]).find(a=>a[1].name==="robots");if(((p==null?void 0:p[1].content)||"").split(/,/u).map(a=>a.trim()).includes("noindex")||i.includes(n.path))return;const w=l(n),{defaultPath:d}=T(n),x=h.get(d)||[];let y=[];x.length>1&&(e.env.isDebug&&x.forEach(a=>{!c[a].lang&&!E.includes(a)&&(u.warn(`"lang" option for ${a} is missing`),E.push(a))}),y=x.map(a=>{var F;return{lang:((F=c[a])==null?void 0:F.lang)||"en",url:`${r}${O(d.replace(/^\//u,a))}`}}));const g={...o?{changefreq:o}:{},links:y,...w?{lastmod:w}:{},...s};e.env.isDebug&&u.info(`sitemap option for ${n.path}: ${JSON.stringify(g,null,2)}`),f.set(n.path,g)}),f},N=async(e,t)=>{const{extraUrls:o=[],xmlNameSpace:i}=t,l=U(t.hostname)?L(t.hostname):`https://${L(t.hostname)}`,m=t.sitemapFilename?O(t.sitemapFilename):"sitemap.xml",r=t.sitemapXSLFilename?O(t.sitemapXSLFilename):"sitemap.xsl",c=t.sitemapXSLTemplate??`${X}sitemap.xsl`,{dir:h,options:{base:f}}=e;u.load(`Generating sitemap to ${S.cyan(`/${m}`)}`),await new Promise(s=>{const p=new G({hostname:l,...i?{xmlns:i}:{}}),w=A(e,t),d=h.dest(m),x=h.dest(r),y=$.createWriteStream(d);p.pipe(y),w.forEach((g,a)=>p.write({url:`${f}${O(a)}`,...g})),y.on("finish",()=>{const g=$.readFileSync(d,{encoding:"utf-8"});$.writeFileSync(d,g.replace('<?xml version="1.0" encoding="UTF-8"?>',`<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="${f}${r}"?>
`)),$.copySync(c,x),s()}),o.forEach(g=>p.write({url:`${f}${O(g)}`})),p.end()}),u.succeed();const n=h.dest("robots.txt");if($.existsSync(n)){u.load(`Appended sitemap path to ${S.cyan("robots.txt")}`);const s=`${(await $.readFile(n,{encoding:"utf8"})).replace(/^Sitemap: .*$/u,"")}
Sitemap: ${l}${f}${m}
`;await $.writeFile(n,s,{flag:"w"}),u.succeed()}},H=(e,t=!0)=>o=>{t&&k(e),o.env.isDebug&&u.info("Options:",e);const i={name:"vuepress-plugin-sitemap2"};return e.hostname?{...i,onGenerated:l=>N(l,e)}:(u.error(`Option ${S.magenta("hostname")} is required!`),i)};export{H as sitemapPlugin};
//# sourceMappingURL=index.js.map
