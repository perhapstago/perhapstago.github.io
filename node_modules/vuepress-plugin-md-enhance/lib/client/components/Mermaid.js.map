{"version":3,"file":"Mermaid.js","sources":["../../../src/client/components/Mermaid.ts"],"sourcesContent":["import { useMutationObserver } from \"@vueuse/core\";\nimport { type MermaidConfig } from \"mermaid\";\nimport {\n  type VNode,\n  computed,\n  defineComponent,\n  h,\n  nextTick,\n  onMounted,\n  ref,\n  watch,\n} from \"vue\";\nimport { LoadingIcon, atou } from \"vuepress-shared/client\";\n\nimport \"../styles/mermaid.scss\";\n\ndeclare const MARKDOWN_ENHANCE_DELAY: number;\ndeclare const MERMAID_OPTIONS: MermaidConfig;\n\nconst getThemeVariables = (isDarkmode: boolean): Record<string, unknown> => {\n  return {\n    dark: isDarkmode,\n    background: isDarkmode ? \"#1e1e1e\" : \"#fff\",\n\n    primaryColor: isDarkmode ? \"#389d70\" : \"#4abf8a\",\n    primaryBorderColor: isDarkmode ? \"#389d70\" : \"#4abf8a\",\n    primaryTextColor: \"#fff\",\n\n    secondaryColor: \"#ffb500\",\n    secondaryBorderColor: isDarkmode ? \"#fff\" : \"#000\",\n    secondaryTextColor: isDarkmode ? \"#ddd\" : \"#333\",\n\n    tertiaryColor: isDarkmode ? \"#282828\" : \"#efeef4\",\n    tertiaryBorderColor: isDarkmode ? \"#bbb\" : \"#242424\",\n    tertiaryTextColor: isDarkmode ? \"#ddd\" : \"#333\",\n\n    // note\n    noteBkgColor: isDarkmode ? \"#f6d365\" : \"#fff5ad\",\n    noteTextColor: \"#242424\",\n    noteBorderColor: isDarkmode ? \"#f6d365\" : \"#333\",\n\n    lineColor: isDarkmode ? \"#d3d3d3\" : \"#333\",\n    textColor: isDarkmode ? \"#fff\" : \"#242424\",\n\n    mainBkg: isDarkmode ? \"#389d70\" : \"#4abf8a\",\n    errorBkgColor: \"#eb4d5d\",\n    errorTextColor: \"#fff\",\n\n    // flowchart\n    nodeBorder: isDarkmode ? \"#389d70\" : \"#4abf8a\",\n    nodeTextColor: isDarkmode ? \"#fff\" : \"#242424\",\n\n    // sequence\n    signalTextColor: isDarkmode ? \"#9e9e9e\" : \"#242424\",\n\n    // class\n    classText: \"#fff\",\n\n    // state\n    labelColor: \"#fff\",\n\n    // colors\n    fillType0: isDarkmode ? \"#cf1322\" : \"#f1636e\",\n    fillType1: \"#f39c12\",\n    fillType2: \"#2ecc71\",\n    fillType3: \"#fa541c\",\n    fillType4: \"#25a55b\",\n    fillType5: \"#13c2c2\",\n    fillType6: \"#096dd9\",\n    fillType7: \"#aa6fe9\",\n  };\n};\n\nexport default defineComponent({\n  // eslint-disable-next-line vue/multi-word-component-names\n  name: \"Mermaid\",\n\n  props: {\n    /**\n     * Mermaid id\n     */\n    id: { type: String, required: true },\n\n    /**\n     * Mermaid config\n     *\n     * Mermaid 配置\n     */\n    code: { type: String, required: true },\n  },\n\n  setup(props) {\n    const mermaidElement = ref<HTMLElement>();\n\n    const svgCode = ref(\"\");\n    const isDarkmode = ref(false);\n\n    const code = computed(() => atou(props.code));\n\n    const renderMermaid = async (): Promise<void> =>\n      Promise.all([\n        import(\n          /* webpackChunkName: \"mermaid\" */ \"mermaid/dist/mermaid.esm.min.mjs\"\n        ),\n        import(\n          /* webpackChunkName: \"mermaid\" */ \"@mermaid-js/mermaid-mindmap/dist/mermaid-mindmap.esm.min.mjs\"\n        ),\n        new Promise((resolve) => setTimeout(resolve, MARKDOWN_ENHANCE_DELAY)),\n      ]).then(async ([{ default: mermaid }, { default: mindmap }]) => {\n        try {\n          await mermaid.registerExternalDiagrams([mindmap]);\n        } catch (err) {\n          // mermaid does not provide a api to get registered diagrams\n        }\n\n        // generate a invisible container\n        const container = document.createElement(\"div\");\n\n        container.style.position = \"relative\";\n        container.style.top = \"-9999px\";\n\n        const renderCallback = (code: string): void => {\n          svgCode.value = code;\n          document.body.removeChild(container);\n        };\n        const chartOptions = { useMaxWidth: false };\n\n        mermaid.initialize({\n          // @ts-ignore\n          theme: \"base\",\n          themeVariables: getThemeVariables(isDarkmode.value),\n          flowchart: chartOptions,\n          sequence: chartOptions,\n          journey: chartOptions,\n          gantt: chartOptions,\n          er: chartOptions,\n          pie: chartOptions,\n\n          ...MERMAID_OPTIONS,\n          startOnLoad: false,\n        });\n\n        // clear SVG Code\n        svgCode.value = \"\";\n\n        document.body.appendChild(container);\n\n        // make sure dom is refreshed\n        await nextTick();\n\n        await mermaid.renderAsync(\n          props.id,\n          code.value,\n          renderCallback,\n          container\n        );\n      });\n\n    onMounted(() => {\n      const html = document.documentElement;\n\n      const getDarkmodeStatus = (): boolean =>\n        html.classList.contains(\"dark\") ||\n        html.getAttribute(\"data-theme\") === \"dark\";\n\n      // FIXME: Should correct handle dark selector\n      isDarkmode.value = getDarkmodeStatus();\n\n      void renderMermaid();\n\n      // watch darkmode change\n      useMutationObserver(\n        html,\n        () => {\n          isDarkmode.value = getDarkmodeStatus();\n        },\n        {\n          attributeFilter: [\"class\", \"data-theme\"],\n          attributes: true,\n        }\n      );\n\n      watch(isDarkmode, () => renderMermaid());\n    });\n\n    return (): VNode =>\n      h(\n        \"div\",\n        {\n          ref: mermaidElement,\n          class: \"mermaid-wrapper\",\n        },\n        svgCode.value\n          ? // mermaid\n            h(\"div\", { class: \"mermaid-content\", innerHTML: svgCode.value })\n          : // loading\n            h(LoadingIcon, { class: \"mermaid-loading\", height: 96 })\n      );\n  },\n});\n"],"names":["getThemeVariables","isDarkmode","defineComponent","props","mermaidElement","ref","svgCode","code","computed","atou","renderMermaid","resolve","mermaid","mindmap","container","renderCallback","chartOptions","nextTick","onMounted","html","getDarkmodeStatus","useMutationObserver","watch","h","LoadingIcon"],"mappings":"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"}